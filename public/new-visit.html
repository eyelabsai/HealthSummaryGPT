<!-- public/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Record New Visit - OpenCare</title>
  <style>
    :root {
      --background: #f8f9fa;
      --card-bg: #ffffff;
      --text-primary: #212529;
      --text-secondary: #6c757d;
      --border-color: #dee2e6;
      --accent-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --success-color: #28a745;
      --warning-color: #ffc107;
      --error-color: #dc3545;
    }

    [data-theme="dark"] {
      --background: #1a202c;
      --card-bg: #2d3748;
      --text-primary: #f7fafc;
      --text-secondary: #a0aec0;
      --border-color: #4a5568;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--background);
      margin: 0;
      padding: 2rem;
      color: var(--text-primary);
    }
    .container {
      max-width: 1400px;
      width: 100%;
      margin: 0 auto;
      padding: 2.5rem 2rem;
    }
    .header {
      text-align: center;
      margin-bottom: 2rem;
      position: relative;
    }
    .header-controls {
      position: absolute;
      top: 0;
      right: 0;
      display: flex;
      gap: 1rem;
      align-items: center;
    }
    .dark-mode-toggle {
      background: #6c757d;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: background 0.2s ease;
    }
    .header h1 {
      font-size: 2.5rem;
      font-weight: 700;
    }
    .back-link {
      position: absolute;
      top: 50%;
      left: 0;
      transform: translateY(-50%);
      text-decoration: none;
      color: var(--text-secondary);
      font-weight: 500;
      transition: color 0.2s ease;
    }
    .back-link:hover {
      color: var(--text-primary);
    }
    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      margin-bottom: 2rem;
      width: 100%;
      box-sizing: border-box;
    }
    .card h2 {
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
      color: var(--text-primary);
    }
    .controls {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .btn {
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    .btn-primary {
      background: var(--accent-gradient);
      color: white;
    }
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .btn-secondary {
      background-color: #e9ecef;
      color: var(--text-primary);
    }
    
    [data-theme="dark"] .btn-secondary {
      background-color: #4a5568;
      color: var(--text-primary);
    }
    
    /* Specialty dropdown styles */
    #specialty {
      flex: 1;
      padding: 0.85rem 1rem;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      font-size: 1.05rem;
      background: var(--card-bg);
      color: var(--text-primary);
    }
    
    [data-theme="dark"] #specialty {
      background: var(--card-bg);
      color: var(--text-primary);
      border-color: var(--border-color);
    }
    
    [data-theme="dark"] #specialty option {
      background: var(--card-bg);
      color: var(--text-primary);
    }
    
    .specialty-helper {
      color: #667eea;
    }
    
    [data-theme="dark"] .specialty-helper {
      color: #90cdf4;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    textarea {
      width: 100%;
      min-height: 150px;
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: var(--card-bg);
      color: var(--text-primary);
      font-size: 1rem;
      line-height: 1.6;
      resize: vertical;
    }
    .status {
      padding: 1rem;
      border-radius: 8px;
      font-weight: 500;
      border-left: 4px solid;
    }
    .status.idle {
      background-color: #f8f9fa;
      border-color: var(--text-secondary);
      color: var(--text-primary);
    }
    
    [data-theme="dark"] .status.idle {
      background-color: rgba(255, 255, 255, 0.05);
    }
    .status.recording {
      background-color: #fff0f1;
      border-color: var(--error-color);
      color: var(--error-color);
    }
    
    [data-theme="dark"] .status.recording {
      background-color: rgba(220, 53, 69, 0.1);
    }
    .status.processing {
      background-color: #fff8e1;
      border-color: var(--warning-color);
      color: #856404;
    }
    
    [data-theme="dark"] .status.processing {
      background-color: rgba(255, 193, 7, 0.1);
      color: #ffc107;
    }
    .status.success {
      background-color: #e9f7ef;
      border-color: var(--success-color);
      color: #155724;
    }
    
    [data-theme="dark"] .status.success {
      background-color: rgba(40, 167, 69, 0.1);
      color: #28a745;
    }
    .card#summaryCard {
      max-width: 100%;
    }
    .summary-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2.5rem;
      margin-bottom: 2rem;
    }
    .summary-grid > div {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .summary-grid textarea,
    .summary-grid select {
      width: 100%;
      min-height: 180px;
      font-size: 1.18rem;
      padding: 1.2rem;
      border-radius: 12px;
      border: 1.5px solid var(--border-color);
      background: var(--card-bg);
      color: var(--text-primary);
      resize: vertical;
      box-sizing: border-box;
    }
    .summary-grid select {
      min-height: unset;
      height: 60px;
      font-size: 1.13rem;
      padding: 1rem 1.2rem;
    }
    
    [data-theme="dark"] .summary-grid select option {
      background: var(--card-bg);
      color: var(--text-primary);
    }
    .recording-info {
      margin-top: 1rem;
      padding: 1rem;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 8px;
      border-left: 4px solid #007bff;
    }
    
    [data-theme="dark"] .recording-info {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
    }
    .recording-timer {
      font-size: 1.1rem;
      font-weight: 600;
      color: #007bff;
      margin-bottom: 0.5rem;
    }
    .recording-size {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }
    .recording-tip {
      font-size: 0.85rem;
      color: var(--text-primary);
      font-style: italic;
      background: rgba(255, 255, 255, 0.7);
      padding: 0.5rem;
      border-radius: 4px;
      margin-top: 0.5rem;
    }
    
    [data-theme="dark"] .recording-tip {
      background: rgba(255, 255, 255, 0.1);
    }
    .medication-verification {
      margin-top: 2rem;
      padding: 1.5rem;
      background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
      border-radius: 8px;
      border-left: 4px solid #ffc107;
    }
    
    [data-theme="dark"] .medication-verification {
      background: linear-gradient(135deg, rgba(255, 193, 7, 0.15) 0%, rgba(255, 193, 7, 0.1) 100%);
    }
    .medication-verification h3 {
      margin-top: 0;
      color: #856404;
      font-size: 1.2rem;
    }
    
    [data-theme="dark"] .medication-verification h3 {
      color: #ffc107;
    }
    
    .medication-list {
      margin-bottom: 1.5rem;
    }
    
    .medication-item-verify {
      background: white;
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
      border: 1px solid #dee2e6;
      color: #212529;
    }
    
    [data-theme="dark"] .medication-item-verify {
      background: var(--card-bg);
      border-color: var(--border-color);
      color: var(--text-primary);
    }
    
    .medication-name {
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
      color: inherit;
    }
    
    .medication-status {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }
    
    .status-new {
      background: #d4edda;
      color: #155724;
    }
    
    [data-theme="dark"] .status-new {
      background: rgba(40, 167, 69, 0.2);
      color: #4caf50;
    }
    
    .status-existing {
      background: #fff3cd;
      color: #856404;
    }
    
    [data-theme="dark"] .status-existing {
      background: rgba(255, 193, 7, 0.2);
      color: #ffc107;
    }
    
    .medication-details {
      font-size: 0.9rem;
      color: #6c757d;
      line-height: 1.4;
    }
    
    [data-theme="dark"] .medication-details {
      color: var(--text-secondary);
    }
    
    /* Medication input fields */
    .med-input {
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background: var(--card-bg);
      color: var(--text-primary);
      font-size: 0.9rem;
    }
    
    [data-theme="dark"] .med-input {
      background: var(--card-bg);
      color: var(--text-primary);
      border-color: var(--border-color);
    }
    
    [data-theme="dark"] .med-input::placeholder {
      color: var(--text-secondary);
    }
    
    /* Remove medication button */
    .remove-med-btn {
      margin-left: 0.5rem;
      padding: 0.5rem;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    
    .remove-med-btn:hover {
      background: #c82333;
    }
    
    /* Medication summary text */
    .med-summary-text.med-summary-mixed {
      color: #856404;
    }
    
    .med-summary-text.med-summary-existing {
      color: #856404;
    }
    
    .med-summary-text.med-summary-new {
      color: #155724;
    }
    
    [data-theme="dark"] .med-summary-text.med-summary-mixed {
      color: #ffc107;
    }
    
    [data-theme="dark"] .med-summary-text.med-summary-existing {
      color: #ffc107;
    }
    
    [data-theme="dark"] .med-summary-text.med-summary-new {
      color: #4caf50;
    }
    
    /* Medication conflict styles */
    .conflict-header {
      color: #dc3545;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    
    [data-theme="dark"] .conflict-header {
      color: #ff6b6b;
    }
    
    .conflict-item {
      border: 1px solid #ffc107;
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 1rem;
      background: #fffbe6;
      color: #212529;
    }
    
    [data-theme="dark"] .conflict-item {
      background: rgba(255, 193, 7, 0.1);
      border-color: #ffc107;
      color: var(--text-primary);
    }
    
    .conflict-btn {
      margin-right: 0.5rem;
      padding: 0.5rem 1rem;
      border: 1px solid #ffc107;
      background: #fff;
      color: #856404;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    .conflict-btn:hover {
      background: #ffc107;
      color: #212529;
    }
    
    [data-theme="dark"] .conflict-btn {
      background: var(--card-bg);
      color: #ffc107;
      border-color: #ffc107;
    }
    
    [data-theme="dark"] .conflict-btn:hover {
      background: #ffc107;
      color: #212529;
    }
    .verification-actions {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }
    
    /* Chronic Conditions Modal Styles */
    .chronic-conditions-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .chronic-conditions-modal-content {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 2rem;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }
    
    .chronic-conditions-modal h3 {
      color: var(--text-primary);
      margin-top: 0;
      margin-bottom: 1rem;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .chronic-conditions-list {
      margin: 1.5rem 0;
    }
    
    .chronic-condition-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      margin-bottom: 0.5rem;
      background: rgba(102, 126, 234, 0.1);
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }
    
    [data-theme="dark"] .chronic-condition-item {
      background: rgba(102, 126, 234, 0.15);
    }
    
    .chronic-condition-checkbox {
      margin-right: 0.5rem;
      transform: scale(1.2);
    }
    
    .chronic-condition-name {
      flex: 1;
      font-weight: 500;
      color: var(--text-primary);
    }
    
    .chronic-condition-status {
      font-size: 0.8rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-weight: 500;
    }
    
    .chronic-condition-status.new {
      background: #d4edda;
      color: #155724;
    }
    
    .chronic-condition-status.existing {
      background: #fff3cd;
      color: #856404;
    }
    
    [data-theme="dark"] .chronic-condition-status.new {
      background: rgba(40, 167, 69, 0.2);
      color: #4caf50;
    }
    
    [data-theme="dark"] .chronic-condition-status.existing {
      background: rgba(255, 193, 7, 0.2);
      color: #ffc107;
    }
    
    .chronic-conditions-modal-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 2rem;
    }
    
    .chronic-conditions-modal-description {
      color: var(--text-secondary);
      margin-bottom: 1.5rem;
      line-height: 1.5;
    }
    @media (max-width: 768px) {
      .summary-grid {
        grid-template-columns: 1fr;
      }
      .back-link {
        position: static;
        transform: none;
        display: block;
        margin-bottom: 1rem;
        text-align: center;
      }
      .verification-actions {
        flex-direction: column;
        align-items: center;
      }
      .verification-actions .btn {
        width: 100%;
        max-width: 300px;
      }
      .medication-verification {
        padding: 1rem;
      }
    }
    @media (max-width: 1500px) {
      .container {
        max-width: 98vw;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <a href="/" class="back-link">← Back to Dashboard</a>
      <div class="header-controls">
        <button id="darkModeToggle" class="dark-mode-toggle">
          <span id="darkModeIcon">🌙</span>
          <span id="darkModeText">Dark</span>
        </button>
      </div>
      <h1>Record New Visit</h1>
    </div>

    <div class="card">
      <h2>Step 1: Record Audio</h2>
      <p style="margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.9rem;">
        💡 For longer visits (1+ minutes), speak clearly and pause between topics. The system can handle recordings up to 50MB.
      </p>
      <div class="controls">
        <button id="startBtn" class="btn btn-primary">🎤 Start Recording</button>
        <button id="stopBtn" class="btn btn-secondary" disabled>⏹ Stop Recording</button>
      </div>
      <div id="status" class="status idle">Ready to record.</div>
      <div id="recordingInfo" class="recording-info" style="display: none;">
        <div class="recording-timer">Duration: <span id="timer">0:00</span></div>
        <div class="recording-size">File size: <span id="fileSize">0 KB</span></div>
        <div class="recording-tip">💡 Tip: For longer visits, speak clearly and pause between topics for better transcription.</div>
      </div>
    </div>

    <div class="card">
      <h2>Step 2: Transcribe & Review</h2>
      <textarea id="transcript" placeholder="Your live transcription will appear here..." readonly></textarea>
    </div>

    <div class="card">
      <h2>Step 3: Generate & Save Summary</h2>
      <button id="summariseBtn" class="btn btn-primary" disabled>📄 Generate Summary</button>
    </div>

    <div class="card" id="summaryCard">
      <h2>Step 4: Review Summary</h2>
      <div class="summary-grid">
        <div>
          <label for="summary">Full Summary</label>
          <textarea id="summary" placeholder="Full summary will appear here..." readonly></textarea>
        </div>
        <div>
          <label for="tldr">TL;DR (Short Summary)</label>
          <textarea id="tldr" placeholder="A short, one-sentence summary..." readonly></textarea>
        </div>
        <div>
          <label for="specialty">Medical Specialty</label>
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <select id="specialty"></select>
          </div>
          <small id="specialtyHelper" class="specialty-helper" style="font-size: 0.95rem; margin-top: 0.3rem; display: block;"></small>
        </div>
        <div>
          <label for="date">Date of Visit</label>
          <textarea id="date" placeholder="The date of the visit..." readonly></textarea>
        </div>
      </div>
      
      <!-- Medication Verification Section -->
      <div id="medicationVerification" class="medication-verification" style="display: none;">
        <h3>Medication Verification</h3>
        <div id="medicationList" class="medication-list">
          <!-- Medications will be populated here -->
        </div>
        <div class="verification-actions">
          <button id="confirmMedsBtn" class="btn btn-primary">✅ Confirm & Save Visit</button>
          <button id="editMedsBtn" class="btn btn-secondary">✏️ Edit Medications</button>
        </div>
      </div>
      
      <div style="text-align: center; margin-top: 2rem;">
        <button id="finishVisitBtn" class="btn btn-primary" style="font-size: 1.1rem; padding: 1rem 2rem;">
          ✅ Finish Visit & Return to Dashboard
        </button>
      </div>
    </div>
  </div>

  <!-- Chronic Conditions Confirmation Modal -->
  <div id="chronicConditionsModal" class="chronic-conditions-modal" style="display: none;">
    <div class="chronic-conditions-modal-content">
      <h3>🩺 Chronic Conditions Detected</h3>
      <div class="chronic-conditions-modal-description">
        We found some chronic conditions mentioned in your visit. Would you like to add them to your profile?
      </div>
      <div id="chronicConditionsList" class="chronic-conditions-list">
        <!-- Conditions will be populated here -->
      </div>
      <div class="chronic-conditions-modal-actions">
        <button id="chronicConditionsSkip" class="btn btn-secondary">Skip All</button>
        <button id="chronicConditionsAdd" class="btn btn-primary">Add Selected</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
  <script src="/js/firebase-client.js"></script>
  <script>
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusEl = document.getElementById('status');
    const transcriptEl = document.getElementById('transcript');
    const summariseBtn = document.getElementById('summariseBtn');
    const summaryCard = document.getElementById('summaryCard');
    const summaryEl = document.getElementById('summary');
    const tldrEl = document.getElementById('tldr');
    const specialtyEl = document.getElementById('specialty');
    const dateEl = document.getElementById('date');
    const recordingInfo = document.getElementById('recordingInfo');
    const timerEl = document.getElementById('timer');
    const fileSizeEl = document.getElementById('fileSize');
    const medicationVerification = document.getElementById('medicationVerification');
    const medicationList = document.getElementById('medicationList');
    const confirmMedsBtn = document.getElementById('confirmMedsBtn');
    const editMedsBtn = document.getElementById('editMedsBtn');
    
    let mediaRecorder, recordedChunks = [];
    let recordingStartTime, recordingTimer;
    let isRecording = false;
    let currentMedications = []; // Store medications from current visit
    let currentMedicationActions = []; // Store medication actions from current visit

    // Add recording timer display
    function updateRecordingTimer() {
      if (!isRecording) return;
      
      const elapsed = Date.now() - recordingStartTime;
      const minutes = Math.floor(elapsed / 60000);
      const seconds = Math.floor((elapsed % 60000) / 1000);
      const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      
      timerEl.textContent = timeString;
      statusEl.textContent = `Recording in progress... ${timeString}`;
      
      // Update file size estimate (rough calculation)
      const estimatedSize = Math.round((elapsed / 1000) * 16); // ~16KB per second
      fileSizeEl.textContent = `${estimatedSize} KB`;
      
      recordingTimer = setTimeout(updateRecordingTimer, 1000);
    }

    startBtn.addEventListener('click', async () => {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert('Audio recording not supported in this browser.');
        return;
      }
      
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            sampleRate: 44100
          } 
        });
        
        recordedChunks = [];
        isRecording = true;
        recordingStartTime = Date.now();
        
        // Use better MIME type for longer recordings
        const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') 
          ? 'audio/webm;codecs=opus' 
          : 'audio/webm';
        
        mediaRecorder = new MediaRecorder(stream, { 
          mimeType: mimeType,
          audioBitsPerSecond: 128000 // Optimize for quality vs file size
        });

        mediaRecorder.ondataavailable = (e) => {
          if (e.data.size > 0) {
            recordedChunks.push(e.data);
            console.log(`Chunk received: ${e.data.size} bytes, total chunks: ${recordedChunks.length}`);
          }
        };

        mediaRecorder.onstop = async () => {
          isRecording = false;
          clearTimeout(recordingTimer);
          recordingInfo.style.display = 'none';
          
          const totalSize = recordedChunks.reduce((sum, chunk) => sum + chunk.size, 0);
          console.log(`Recording stopped. Total size: ${totalSize} bytes`);
          
          if (totalSize === 0) {
            statusEl.textContent = 'Error: No audio data recorded.';
            statusEl.className = 'status error';
            startBtn.disabled = false;
            return;
          }

          statusEl.textContent = 'Processing audio...';
          statusEl.className = 'status processing';
          
          const blob = new Blob(recordedChunks, { type: mimeType });
          const formData = new FormData();
          formData.append('audio', blob);

          try {
            // Add timeout for longer recordings
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 120000); // 2 minute timeout
            
            const res = await fetch('/api/transcribe', { 
              method: 'POST', 
              body: formData,
              signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            
            if (!res.ok) {
              throw new Error(`HTTP ${res.status}: ${res.statusText}`);
            }
            
            const data = await res.json();
            if (data.success) {
              transcriptEl.value = data.transcript;
              statusEl.textContent = 'Transcription complete! Ready to summarize.';
              statusEl.className = 'status success';
              summariseBtn.disabled = false;
            } else {
              throw new Error(data.error || 'Transcription failed.');
            }
          } catch (err) {
            if (err.name === 'AbortError') {
              statusEl.textContent = 'Error: Transcription timed out. Try a shorter recording.';
            } else {
              statusEl.textContent = `Error: ${err.message}`;
            }
            statusEl.className = 'status error';
          } finally {
            startBtn.disabled = false;
            // Stop all tracks to release microphone
            stream.getTracks().forEach(track => track.stop());
          }
        };

        // Start recording with 1-second chunks for better handling of long recordings
        mediaRecorder.start(1000);
        startBtn.disabled = true;
        stopBtn.disabled = false;
        summariseBtn.disabled = true;
        transcriptEl.value = '';
        summaryEl.value = '';
        tldrEl.value = '';
        specialtyEl.value = '';
        dateEl.value = '';
        statusEl.textContent = 'Recording in progress... 0:00';
        statusEl.className = 'status recording';
        
        // Show recording info
        recordingInfo.style.display = 'block';
        timerEl.textContent = '0:00';
        fileSizeEl.textContent = '0 KB';
        
        // Start timer update
        updateRecordingTimer();
        
      } catch (err) {
        console.error('Recording error:', err);
        alert('Could not start microphone. Please check permissions.');
      }
    });

    stopBtn.addEventListener('click', () => {
      if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        stopBtn.disabled = true;
      }
    });

    const finishVisitBtn = document.getElementById('finishVisitBtn');

    summariseBtn.addEventListener('click', async () => {
      const transcript = transcriptEl.value.trim();
      if (!transcript) return alert('No transcript to summarize.');

      summariseBtn.disabled = true;
      statusEl.textContent = 'Generating summary...';
      statusEl.className = 'status processing';

      try {
        const res = await fetch('/api/summarise', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ transcript })
        });
        const data = await res.json();
        if (data.success) {
          summaryCard.style.display = 'block';
          summaryEl.value = data.summary || '';
          tldrEl.value = data.tldr || '';
          populateSpecialtyDropdown(data.specialty || '');
          specialtyEl.value = data.specialty || '';
          // If date is missing, 'Not specified', or 'TODAY', set to today
          let summaryDate = data.date && data.date.trim().toLowerCase() !== 'not specified' && data.date.trim().toLowerCase() !== 'today'
            ? data.date
            : new Date().toISOString().split('T')[0];
          dateEl.value = summaryDate;
          document.getElementById('specialtyHelper').textContent = data.specialty ? `AI suggested: ${data.specialty}. You can change this if needed.` : '';
          
          // Handle chronic conditions if found
          if (data.chronicConditions && data.chronicConditions.length > 0) {
            await showChronicConditionsModal(data.chronicConditions);
          }
          
          // Use medication verification instead of direct saving
          displayMedicationVerification(data.medications || [], data.medicationActions || []);
        } else {
          throw new Error(data.error || 'Summarization failed.');
        }
      } catch (err) {
        statusEl.textContent = `Error: ${err.message}`;
        statusEl.className = 'status error';
      } finally {
        summariseBtn.disabled = false;
      }
    });

    // Add event listener for finish visit button
    finishVisitBtn.addEventListener('click', () => {
      // If medications are being verified, don't allow finishing yet
      if (medicationVerification.style.display !== 'none') {
        alert('Please review and confirm medications before finishing the visit.');
        return;
      }
      
      // If visit hasn't been saved yet (no medications), save it now
      if (summaryEl.value && !localStorage.getItem('opencare_visits')) {
        const newVisit = {
          id: Date.now().toString(),
          summary: summaryEl.value || 'No summary.',
          tldr: tldrEl.value || 'No TLDR.',
          specialty: specialtyEl.value || 'Uncategorized',
          date: dateEl.value || new Date().toISOString().split('T')[0]
        };
        
        const visits = JSON.parse(localStorage.getItem('opencare_visits')) || [];
        visits.unshift(newVisit);
        localStorage.setItem('opencare_visits', JSON.stringify(visits));
      }
      
      window.location.href = '/';
    });

    // Add event listeners for medication verification
    confirmMedsBtn.addEventListener('click', async () => {
      // Remove empty medications
      const medsToSave = currentMedications.filter(med => med.name && med.name.trim() !== '');
      // Fetch current active medications from Firestore
      let existingMeds = [];
      try {
        existingMeds = await firebaseClient.getUserMedications();
      } catch (err) {
        statusEl.textContent = 'Error fetching current medications: ' + err.message;
        statusEl.className = 'status error';
        return;
      }
      // Find conflicts
      const conflicts = [];
      const medsToActuallySave = [];
      medsToSave.forEach(newMed => {
        const match = existingMeds.find(
          m => m.name && newMed.name && m.name.toLowerCase() === newMed.name.toLowerCase()
        );
        if (match) {
          conflicts.push({ existing: match, incoming: newMed });
        } else {
          medsToActuallySave.push(newMed);
        }
      });
      if (conflicts.length > 0) {
        // Show conflict UI
        let conflictHtml = '<div class="conflict-header">Medication conflict detected! Please clarify:</div>';
        conflictHtml += conflicts.map((c, idx) => `
          <div class="conflict-item">
            <div><b>${c.incoming.name}</b> already exists in your current medications.</div>
            <div style="margin-top:0.5rem;">
              <b>Existing:</b> ${c.existing.dosage || 'Not specified'} ${c.existing.frequency || 'Not specified'} ${c.existing.route || 'Not specified'}
              <br/>
              <b>New:</b> ${c.incoming.dosage || 'Not specified'} ${c.incoming.frequency || 'Not specified'} ${c.incoming.route || 'Not specified'}
            </div>
            <div style="margin-top:0.5rem;">
              <button type="button" class="conflict-btn" data-action="keep" data-idx="${idx}">Keep Existing</button>
              <button type="button" class="conflict-btn" data-action="replace" data-idx="${idx}">Replace with New</button>
              <button type="button" class="conflict-btn" data-action="both" data-idx="${idx}">Keep Both</button>
            </div>
          </div>
        `).join('');
        medicationList.innerHTML = conflictHtml;
        // Handle user choice
        const userChoices = Array(conflicts.length).fill(null);
        medicationList.querySelectorAll('.conflict-btn').forEach(btn => {
          btn.addEventListener('click', e => {
            const idx = +btn.dataset.idx;
            const action = btn.dataset.action;
            userChoices[idx] = action;
            // If all resolved, proceed
            if (userChoices.every(choice => choice)) {
              // Build final list
              const finalMeds = [...medsToActuallySave];
              conflicts.forEach((c, i) => {
                if (userChoices[i] === 'replace') {
                  // Discontinue existing, add new
                  firebaseClient.discontinueMedication(c.existing.id, 'Discontinued per doctor instructions');
                  finalMeds.push(c.incoming);
                } else if (userChoices[i] === 'both') {
                  finalMeds.push(c.incoming);
                } // else keep existing (do nothing)
              });
              saveVisitAndMedications(finalMeds, currentMedicationActions);
              medicationVerification.style.display = 'none';
              finishVisitBtn.style.display = 'inline-block';
            } else {
              // Optionally, highlight unresolved
            }
          });
        });
        return;
      }
      // No conflicts, proceed as normal
      saveVisitAndMedications(medsToActuallySave, currentMedicationActions);
      medicationVerification.style.display = 'none';
      finishVisitBtn.style.display = 'inline-block';
    });

    editMedsBtn.addEventListener('click', () => {
      // The editing interface is already available in the medication verification section
      // Just update the status to indicate editing mode
      statusEl.textContent = 'Medication editing mode: Edit medications above, then click "Confirm & Save Visit" when ready.';
      statusEl.className = 'status processing';
      
      // Scroll to the medication list for better UX
      medicationList.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    // Function to verify medications against existing ones
    function verifyMedications(newMedications) {
      const existingMeds = JSON.parse(localStorage.getItem('opencare_medications')) || [];
      const existingMedNames = new Set(existingMeds.map(m => m.name.toLowerCase()));
      
      const verifiedMeds = newMedications.map(med => ({
        ...med,
        isExisting: existingMedNames.has(med.name.toLowerCase()),
        existingMed: existingMeds.find(m => m.name.toLowerCase() === med.name.toLowerCase())
      }));
      
      return verifiedMeds;
    }

    // Populate specialty dropdown options
    function populateSpecialtyDropdown(selectedValue) {
      const specialtyOptions = [
        '', 'Primary Care (PCP)', 'Family Medicine', 'Internal Medicine', 'Cardiology', 'Ophthalmology',
        'Dermatology', 'Orthopedics', 'Neurology', 'Endocrinology', 'Gastroenterology', 'Pulmonology',
        'Rheumatology', 'Urology', 'Gynecology', 'Obstetrics', 'Pediatrics', 'Psychiatry', 'Oncology',
        'Emergency Medicine', 'Urgent Care', 'Physical Therapy', 'Occupational Therapy', 'Nutrition', 'Other'
      ];
      specialtyEl.innerHTML = '';
      specialtyOptions.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt;
        option.textContent = opt === '' ? 'Select specialty...' : opt;
        specialtyEl.appendChild(option);
      });
      if (selectedValue && specialtyOptions.includes(selectedValue)) {
        specialtyEl.value = selectedValue;
      } else {
        specialtyEl.value = '';
      }
    }

    // Call this on page load
    populateSpecialtyDropdown();

    // Function to display medication verification interface
    function displayMedicationVerification(medications, medicationActions) {
      console.log('displayMedicationVerification called with:');
      console.log('medications:', medications);
      console.log('medicationActions:', medicationActions);
      
      // Detect stop instructions in medications and convert to medication actions
      const stopInstructions = [
        'stop using', 'discontinue', 'stop taking', 'cease', 'end', 'no longer need',
        'can stop', 'should stop', 'stop', 'discontinue the use of'
      ];
      
      const detectedStopActions = [];
      const filteredMedications = [];
      
      // First, check if AI already detected stop actions for these medications
      const aiStopActions = (medicationActions || []).filter(action => action.action === 'stop');
      
      medications.forEach(med => {
        // Check if AI already detected a stop action for this medication
        const aiStopAction = aiStopActions.find(action => 
          action.medicationName && action.medicationName.toLowerCase() === med.name.toLowerCase()
        );
        
        if (aiStopAction) {
          // AI already detected this as a stop action, use the AI's reason
          detectedStopActions.push(aiStopAction);
        } else {
          // Check if instructions contain stop keywords
          const instructions = (med.fullInstructions || '').toLowerCase();
          const isStopInstruction = stopInstructions.some(stop => instructions.includes(stop));
          
          if (isStopInstruction) {
            // Convert to medication action (fallback detection)
            detectedStopActions.push({
              action: 'stop',
              medicationName: med.name,
              reason: med.fullInstructions || 'Discontinued per doctor instructions'
            });
          } else {
            // Keep as regular medication
            filteredMedications.push(med);
          }
        }
      });
      
      // Combine AI actions with detected actions, avoiding duplicates
      const allMedicationActions = [...(medicationActions || []), ...detectedStopActions];
      
      if (!filteredMedications || filteredMedications.length === 0) {
        // No medications to verify, proceed directly
        finishVisitBtn.style.display = 'inline-block';
        saveVisitAndMedications(filteredMedications || [], allMedicationActions || []);
        return;
      }
      
      currentMedications = filteredMedications.map(med => ({ ...med })); // Deep copy
      currentMedicationActions = allMedicationActions.map(action => ({ ...action })); // Deep copy
      
      function renderMedList() {
        const existingCount = currentMedications.filter(med => med.isExisting).length;
        const newCount = currentMedications.filter(med => !med.isExisting).length;
        
        let summaryText = '';
        if (existingCount > 0 && newCount > 0) {
          summaryText = `<p class="med-summary-text med-summary-mixed" style="margin-bottom: 1rem; font-weight: 500;">Found ${newCount} new medication(s) and ${existingCount} already prescribed medication(s).</p>`;
        } else if (existingCount > 0) {
          summaryText = `<p class="med-summary-text med-summary-existing" style="margin-bottom: 1rem; font-weight: 500;">All ${existingCount} medication(s) are already prescribed.</p>`;
        } else {
          summaryText = `<p class="med-summary-text med-summary-new" style="margin-bottom: 1rem; font-weight: 500;">Found ${newCount} new medication(s) to add.</p>`;
        }
        
        medicationList.innerHTML = summaryText + currentMedications.map((med, idx) => `
          <div class="medication-item-verify" data-idx="${idx}">
            <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
              <input type="text" class="med-input" data-field="name" value="${med.name || ''}" placeholder="Medication name" style="flex:2; min-width: 120px;" />
              <input type="text" class="med-input" data-field="dosage" value="${med.dosage || ''}" placeholder="Dosage" style="flex:1; min-width: 80px;" />
              <input type="text" class="med-input" data-field="frequency" value="${med.frequency || ''}" placeholder="Frequency" style="flex:1; min-width: 80px;" />
              <input type="text" class="med-input" data-field="timing" value="${med.timing || ''}" placeholder="Timing" style="flex:1; min-width: 80px;" />
              <input type="text" class="med-input" data-field="route" value="${med.route || ''}" placeholder="Route" style="flex:1; min-width: 80px;" />
              <input type="text" class="med-input" data-field="laterality" value="${med.laterality || ''}" placeholder="Eye/Side" style="flex:1; min-width: 80px;" />
              <input type="text" class="med-input" data-field="duration" value="${med.duration || ''}" placeholder="Duration" style="flex:1; min-width: 80px;" />
              <button type="button" class="remove-med-btn" data-idx="${idx}">🗑</button>
            </div>
            <textarea class="med-input" data-field="fullInstructions" placeholder="Full instructions" style="width:100%; margin-top:0.5rem; min-height: 60px; resize: vertical;">${med.fullInstructions || ''}</textarea>
          </div>
        `).join('') + `
          <button type="button" id="addMedicationBtn" class="btn btn-secondary" style="margin-top:1rem;">+ Add Medication</button>
        `;
        
        // Add event listeners for input changes
        medicationList.querySelectorAll('.med-input').forEach(input => {
          input.addEventListener('input', e => {
            const idx = +input.closest('.medication-item-verify').dataset.idx;
            const field = input.dataset.field;
            currentMedications[idx][field] = input.value;
          });
        });
        
        // Remove medication
        medicationList.querySelectorAll('.remove-med-btn').forEach(btn => {
          btn.addEventListener('click', e => {
            const idx = +btn.dataset.idx;
            currentMedications.splice(idx, 1);
            renderMedList();
          });
        });
        
        // Add medication
        const addBtn = document.getElementById('addMedicationBtn');
        if (addBtn) {
          addBtn.addEventListener('click', () => {
            currentMedications.push({
              name: '', dosage: '', frequency: '', timing: '', route: '', laterality: '', duration: '', fullInstructions: ''
            });
            renderMedList();
          });
        }
      }
      
      renderMedList();
      
      // Show medication actions that will be processed
      if (allMedicationActions.length > 0) {
        const actionsHtml = allMedicationActions.map(action => {
          const actionIcon = action.action === 'stop' ? '⏹️' : 
                           action.action === 'start' ? '▶️' : 
                           action.action === 'modify' ? '✏️' : '🔄';
          const actionText = action.action === 'stop' ? 'Discontinue' :
                           action.action === 'start' ? 'Start' :
                           action.action === 'modify' ? 'Modify' : 'Continue';
          
          return `
            <div class="medication-action-item" style="background: #e3f2fd; padding: 0.75rem; border-radius: 6px; margin-bottom: 0.5rem; border-left: 4px solid #2196f3;">
              <div style="font-weight: 600; color: #1976d2;">
                ${actionIcon} ${actionText}: ${action.medicationName}
              </div>
              ${action.reason ? `<div style="font-size: 0.9rem; color: #424242; margin-top: 0.25rem;"><strong>Reason:</strong> ${action.reason}</div>` : ''}
              ${action.newInstructions ? `<div style="font-size: 0.9rem; color: #424242; margin-top: 0.25rem;"><strong>New Instructions:</strong> ${action.newInstructions}</div>` : ''}
            </div>
          `;
        }).join('');
        
        const actionsSection = `
          <div class="medication-actions-section" style="margin-bottom: 1.5rem;">
            <h4 style="margin-bottom: 0.75rem; color: #1976d2;">Medication Actions to Process:</h4>
            ${actionsHtml}
          </div>
        `;
        
        medicationList.innerHTML = actionsSection + medicationList.innerHTML;
      }
      
      medicationVerification.style.display = 'block';
      finishVisitBtn.style.display = 'none';
    }

    // Function to toggle specialty field editing
    function toggleSpecialtyEdit() {
      const specialtySelect = document.getElementById("specialty");
      const editBtn = document.getElementById("editSpecialtyBtn");
      
      if (specialtySelect.disabled) {
        specialtySelect.disabled = false;
        specialtySelect.style.background = "";
        specialtySelect.style.borderColor = "#667eea";
        editBtn.textContent = "✓ Done";
        editBtn.className = "btn btn-primary";
        specialtySelect.focus();
      } else {
        specialtySelect.disabled = true;
        specialtySelect.style.background = "";
        specialtySelect.style.borderColor = "";
        editBtn.textContent = "✏️ Edit";
        editBtn.className = "btn btn-secondary";
      }
    }

    // Function to show chronic conditions confirmation modal
    async function showChronicConditionsModal(newConditions) {
      try {
        const user = firebase.auth().currentUser;
        if (!user || !newConditions || newConditions.length === 0) {
          return;
        }

        // Get current user profile to check existing conditions
        const currentProfile = await firebaseClient.getUserProfile();
        let currentConditions = [];
        
        if (currentProfile && currentProfile.chronicConditions) {
          currentConditions = currentProfile.chronicConditions.split(',').map(s => s.trim()).filter(Boolean);
        }

        // Categorize conditions as new or existing
        const conditionsToShow = newConditions.map(condition => ({
          name: condition,
          isNew: !currentConditions.some(existing => existing.toLowerCase() === condition.toLowerCase()),
          selected: true // Default to selected
        }));

        // Only show modal if there are new conditions
        const newConditionsToShow = conditionsToShow.filter(c => c.isNew);
        if (newConditionsToShow.length === 0) {
          return; // No new conditions to add
        }

        // Populate the modal
        const chronicConditionsList = document.getElementById('chronicConditionsList');
        const modal = document.getElementById('chronicConditionsModal');
        
        chronicConditionsList.innerHTML = conditionsToShow.map((condition, index) => `
          <div class="chronic-condition-item">
            <input type="checkbox" 
                   id="chronic-condition-${index}" 
                   class="chronic-condition-checkbox" 
                   ${condition.selected ? 'checked' : ''} 
                   ${!condition.isNew ? 'disabled' : ''}>
            <div class="chronic-condition-name">${condition.name}</div>
            <div class="chronic-condition-status ${condition.isNew ? 'new' : 'existing'}">
              ${condition.isNew ? 'New' : 'Already added'}
            </div>
          </div>
        `).join('');

        // Show the modal
        modal.style.display = 'flex';

        // Handle modal actions
        return new Promise((resolve) => {
          const addBtn = document.getElementById('chronicConditionsAdd');
          const skipBtn = document.getElementById('chronicConditionsSkip');

          const cleanup = () => {
            modal.style.display = 'none';
            addBtn.removeEventListener('click', handleAdd);
            skipBtn.removeEventListener('click', handleSkip);
          };

          const handleAdd = async () => {
            const selectedConditions = [];
            conditionsToShow.forEach((condition, index) => {
              const checkbox = document.getElementById(`chronic-condition-${index}`);
              if (checkbox && checkbox.checked && condition.isNew) {
                selectedConditions.push(condition.name);
              }
            });

            if (selectedConditions.length > 0) {
              await updateUserChronicConditions(selectedConditions, currentConditions, currentProfile);
              const conditionText = selectedConditions.length === 1 ? 'condition' : 'conditions';
              statusEl.textContent = `Summary complete! Added ${selectedConditions.length} new chronic ${conditionText}: ${selectedConditions.join(', ')}`;
              statusEl.className = 'status success';
            }

            cleanup();
            resolve();
          };

          const handleSkip = () => {
            cleanup();
            resolve();
          };

          addBtn.addEventListener('click', handleAdd);
          skipBtn.addEventListener('click', handleSkip);

          // Close modal when clicking outside
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              handleSkip();
            }
          });
        });
      } catch (err) {
        console.error('Error showing chronic conditions modal:', err);
      }
    }

    // Function to update user's chronic conditions (helper function)
    async function updateUserChronicConditions(newConditions, currentConditions, currentProfile) {
      try {
        const user = firebase.auth().currentUser;
        if (!user) {
          console.log('User not logged in, skipping chronic condition update');
          return;
        }

        // Merge new conditions with existing ones, avoiding duplicates
        const allConditions = [...new Set([...currentConditions, ...newConditions])];
        
        // Update user profile with merged conditions
        await firebaseClient.setUserProfile({
          ...currentProfile,
          chronicConditions: allConditions.join(', ')
        });

        console.log('Updated chronic conditions:', allConditions);
      } catch (err) {
        console.error('Error updating chronic conditions:', err);
        throw err;
      }
    }

    // Function to process medication actions (stop, modify, etc.)
    async function processMedicationActions(medicationActions, visitDate) {
      if (!medicationActions || medicationActions.length === 0) {
        return { actionsToProcess: [], warnings: [] };
      }
      const actionsToProcess = [];
      const warnings = [];
      for (const action of medicationActions) {
        const { action: actionType, medicationName, genericReference, reason, newInstructions } = action;
        if (actionType === 'stop' || actionType === 'discontinue') {
          let targetMedication = null;
          if (medicationName) {
            targetMedication = await firebaseClient.getMedicationByName(medicationName);
          }
          if (!targetMedication && genericReference) {
            const allMeds = await firebaseClient.getUserMedications();
            targetMedication = allMeds.find(med => 
              med.name.toLowerCase().includes(genericReference.toLowerCase()) ||
              (med.fullInstructions && med.fullInstructions.toLowerCase().includes(genericReference.toLowerCase()))
            );
          }
          if (targetMedication) {
            actionsToProcess.push({
              type: 'stop',
              medicationId: targetMedication.id,
              medicationName: targetMedication.name,
              reason: reason || 'Discontinued per doctor instructions',
              visitDate: visitDate
            });
          } else {
            warnings.push(`Could not find an active medication to discontinue for: ${medicationName || genericReference}`);
          }
        } else if (actionType === 'modify') {
          const targetMedication = await firebaseClient.getMedicationByName(medicationName);
          if (targetMedication) {
            actionsToProcess.push({
              type: 'modify',
              medicationId: targetMedication.id,
              medicationName: targetMedication.name,
              newInstructions: newInstructions,
              reason: reason || 'Modified per doctor instructions',
              visitDate: visitDate
            });
          } else {
            warnings.push(`Could not find an active medication to modify for: ${medicationName}`);
          }
        }
      }
      return { actionsToProcess, warnings };
    }

    // UI function to display medication action warnings
    function displayMedicationActionWarnings(warnings) {
      if (!warnings || warnings.length === 0) return '';
      return `
        <div class="medication-action-warnings" style="background:#fff3cd;color:#856404;padding:1em;border-radius:6px;margin-bottom:1em;border:1px solid #ffeeba;">
          <strong>⚠️ Medication Action Warnings:</strong>
          <ul style="margin:0.5em 0 0 1.2em;">
            ${warnings.map(w => `<li>${w}</li>`).join('')}
          </ul>
          <div style="font-size:0.95em;margin-top:0.5em;">Please review and clarify before saving.</div>
        </div>
      `;
    }

    // Updated saveVisitAndMedications to handle medicationActions and show warnings
    async function saveVisitAndMedications(medications, medicationActions = []) {
      const user = firebase.auth().currentUser;
      if (!user) {
        statusEl.textContent = 'Error: Not logged in.';
        statusEl.className = 'status error';
        return;
      }
      const userId = user.uid;
      let visitDate = dateEl.value && dateEl.value.trim() !== '' && dateEl.value.trim().toLowerCase() !== 'not specified' && dateEl.value.trim().toLowerCase() !== 'today'
        ? dateEl.value.trim()
        : new Date().toISOString().split('T')[0];
      const specialtyValue = document.getElementById('specialty').value || 'Uncategorized';
      const newVisit = {
        date: visitDate,
        specialty: specialtyValue,
        summary: summaryEl.value || 'No summary.',
        tldr: tldrEl.value || 'No TLDR.',
        transcript: transcriptEl.value || '',
        userId,
        medicationActions: medicationActions || []
      };
      try {
        // Process medication actions first
        let actionsToProcess = [];
        let warnings = [];
        if (medicationActions && medicationActions.length > 0) {
          const result = await processMedicationActions(medicationActions, visitDate);
          actionsToProcess = result.actionsToProcess;
          warnings = result.warnings;
        }
        // If there are warnings, show them and do not proceed
        if (warnings.length > 0) {
          const warningHtml = displayMedicationActionWarnings(warnings);
          // Insert warning above medication verification list
          const medList = document.getElementById('medicationList');
          if (medList) {
            medList.innerHTML = warningHtml + medList.innerHTML;
          } else {
            alert(warnings.join('\n'));
          }
          statusEl.textContent = 'Please review medication action warnings.';
          statusEl.className = 'status error';
          return;
        }
        const visitRef = await firebaseClient.createVisit(newVisit);
        for (const action of actionsToProcess) {
          if (action.type === 'stop') {
            await firebaseClient.discontinueMedication(action.medicationId, action.reason);
            console.log(`Discontinued medication: ${action.medicationName} - Reason: ${action.reason}`);
          } else if (action.type === 'modify') {
            await firebaseClient.updateMedication(action.medicationId, {
              fullInstructions: action.newInstructions
            });
            console.log(`Modified medication: ${action.medicationName}`);
          }
        }
        if (medications && medications.length > 0) {
          for (const med of medications) {
            if (!med.isExisting) {
              const { existingMed, isExisting, ...medDataRaw } = med;
              const medData = {};
              Object.keys(medDataRaw).forEach(key => {
                if (medDataRaw[key] !== undefined) {
                  medData[key] = medDataRaw[key];
                }
              });
              medData.visitDate = visitDate;
              medData.userId = userId;
              await firebaseClient.createMedication(medData);
            }
          }
        }
        statusEl.textContent = 'Summary complete and saved! Visit automatically saved to dashboard.';
        statusEl.className = 'status success';
        finishVisitBtn.style.display = 'inline-block';
      } catch (err) {
        statusEl.textContent = `Error saving to Firestore: ${err.message}`;
        statusEl.className = 'status error';
        console.error('Error saving to Firestore:', err);
      }
    }

    // Dark mode toggle logic
    const darkModeToggle = document.getElementById('darkModeToggle');
    const darkModeIcon = document.getElementById('darkModeIcon');
    const darkModeText = document.getElementById('darkModeText');
    
    // Check for saved theme preference or default to light mode
    const currentTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', currentTheme);
    
    // Update button appearance based on current theme
    function updateDarkModeButton(theme) {
      if (theme === 'dark') {
        darkModeIcon.textContent = '☀️';
        darkModeText.textContent = 'Light';
        darkModeToggle.style.background = '#f59e0b';
      } else {
        darkModeIcon.textContent = '🌙';
        darkModeText.textContent = 'Dark';
        darkModeToggle.style.background = '#6c757d';
      }
    }
    
    updateDarkModeButton(currentTheme);
    
    darkModeToggle.onclick = function() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateDarkModeButton(newTheme);
    };
  </script>
</body>
</html>